# Mapbuilder Tool Analysis for CZQM/CZQX

## ğŸ¯ What Is Mapbuilder?

**Mapbuilder** is a Python tool that generates EuroScope maps (TopSky and Ground Radar Plugin) from aviation data sources like AIXM, KML, and sector files.

**Original Repository:** VATGER-Nav (German vACC)  
**Your Fork:** skyelaird/mapbuilder  
**License:** MIT (âœ… Good for use!)

---

## ğŸ“Š What It Can Do

### Input Data Sources

The tool can parse and process:

1. **AIXM (Aeronautical Information Exchange Model)**
   - XML-based aviation data format
   - Contains airspace boundaries, procedures, navaids, airports
   - Used by many civil aviation authorities

2. **KML (Keyhole Markup Language)**
   - Google Earth format
   - Can contain geographic features, polygons, lines
   - Good for custom airspace definitions

3. **EuroScope Sector Files (.sct)**
   - Runway definitions
   - Coordinate parsing

4. **EuroScope ESE Files (.ese)**
   - SID/STAR procedures

5. **Sector Definition Files**
   - Custom format for sector boundaries
   - Pattern: `ICAOÂ·SectorNameÂ·LowerÂ·Upper Lat Lon Lat Lon`

6. **GeoPackage (.gpkg)**
   - Geographic database format
   - Can contain multiple layers

7. **GeoJSON**
   - Geographic features in JSON format
   - Easy to create and edit

8. **Raw Text Files**
   - For custom data

### Output Formats

Generates:
- **TopSky Maps** (`TopSkyMaps.txt`)
- **Ground Radar Plugin Maps** (GRP formats)
- **EuroScope Symbology** definitions

---

## ğŸ› ï¸ How It Works

### Architecture

```
Source Data â†’ Parse â†’ Transform â†’ Jinja2 Templates â†’ Output Files
```

1. **Configuration:** `mapbuilder.toml` defines data sources and outputs
2. **Data Parsing:** Reads AIXM, KML, sector files, etc.
3. **Processing:** Combines, simplifies, filters geometries
4. **Template Rendering:** Uses Jinja2 to generate EuroScope format
5. **Output:** Writes TopSkyMaps.txt, GRP files, etc.

### Key Features

- **Geometry Processing:**
  - Combine polygons
  - Simplify complex shapes
  - Convert between formats (lines, polygons, coordinates)
  - Buffer zones

- **Template Engine:**
  - Jinja2 templates for output formatting
  - Custom filters for geographic operations
  - Can generate any text-based format

- **Caching:**
  - Downloads AIXM data once
  - Stores in `.cache/` directory
  - Speeds up subsequent builds

- **DFS Integration:**
  - Can download German AIP data automatically
  - Pattern: `dfs:AMDT_ID:LEAF:FORMAT`

---

## ğŸ’¡ How You Could Use It for CZQM/CZQX

### Use Case 1: Automate TopSkyMaps.txt Generation

**Current Situation:**
- You manually maintain TopSkyMaps.txt
- 2.1MB file with airspace, procedures, RF arcs
- Updates needed every AIRAC cycle

**With Mapbuilder:**
```toml
# mapbuilder.toml
[data.canadian_airspace]
type = "aixm"
source = "path/to/navcanada_aixm.xml"

[data.class_g]
type = "geojson"
source = "class_g_boundaries.geojson"

[data.czqm_sectors]
type = "sectors"
source = "czqm_sectors.txt"
```

Then create Jinja2 templates:
```jinja
{# TopSkyMaps.txt.jinja #}
; Generated by mapbuilder on {{ now }}
; AIRAC Cycle {{ airac }}

; Class G Airspace
{% for feature in data.class_g %}
COORD:{{ feature.name }}:{{ feature.coords }}
{% endfor %}

; Sector Boundaries
{% for sector in data.czqm_sectors %}
COORDLINE:{{ sector.name }}:{{ sector.lines }}
{% endfor %}
```

**Benefits:**
- âœ… Automated AIRAC updates
- âœ… Consistent formatting
- âœ… Version control for source data
- âœ… Reduce manual errors

### Use Case 2: Generate Ground Radar Maps

**For CYHZ, CYQM, CYYT, CYSJ, CYFC:**

If you have AIXM data:
```toml
[data.cyhz_airport]
type = "aixm"
source = "cyhz_aixm.xml"

[runways.CYHZ]
"05" = { heading = 51, thr_lat = "44.875", thr_lon = "-63.508" }
"23" = { heading = 231, thr_lat = "44.894", thr_lon = "-63.525" }
```

Template generates:
- Taxiway layouts
- Runway markings
- Apron boundaries
- Stand positions

**Benefits:**
- âœ… Accurate airport layouts
- âœ… Easy to update
- âœ… Generate multiple airports from same source

### Use Case 3: RNAV RF Arc Generation

**Instead of your custom Python tool:**

Mapbuilder can:
- Parse procedure definitions from ESE files
- Calculate RF arc coordinates
- Generate TopSky COORD/COORDPOLY lines
- Apply to multiple procedures automatically

**Advantage:** Integrated with other map generation

### Use Case 4: Custom Airspace Visualization

Create GeoJSON for special features:
```json
{
  "type": "Feature",
  "properties": { "name": "MILITARY_AREA" },
  "geometry": {
    "type": "Polygon",
    "coordinates": [[[-63.5, 44.5], ...]]
  }
}
```

Mapbuilder generates TopSky format automatically.

---

## ğŸš€ Getting Started

### 1. Install Dependencies

```bash
cd D:\GitHub\mapbuilder

# Create virtual environment
python -m venv venv
venv\Scripts\activate

# Install with Poetry (recommended)
pip install poetry --break-system-packages
poetry install

# Or install dependencies manually
pip install -r requirements.txt --break-system-packages
```

### 2. Create a Test Project

```bash
mkdir D:\GitHub\CZQM-Mapbuilder-Test
cd D:\GitHub\CZQM-Mapbuilder-Test
mkdir mapdata output
```

### 3. Create Configuration

Create `mapdata/mapbuilder.toml`:
```toml
[data.test_sectors]
type = "sct"
source = "D:/Path/To/CZQQ.sct"

[runways.CYHZ]
"05" = { heading = 51 }
"14" = { heading = 141 }
"23" = { heading = 231 }
"32" = { heading = 321 }
```

### 4. Create Template

Create `mapdata/TestMap.txt.jinja`:
```jinja
; Test TopSky Map
; Generated {{ now }}

{% for runway in runways.CYHZ %}
; Runway {{ runway }}
{% endfor %}
```

### 5. Run Mapbuilder

```bash
cd D:\GitHub\mapbuilder
poetry run mapbuilder D:\GitHub\CZQM-Mapbuilder-Test\output -s D:\GitHub\CZQM-Mapbuilder-Test\mapdata
```

---

## ğŸ“ Project Structure (Recommended)

```
D:\GitHub\CZQM-Mapbuilder\          # Your mapbuilder project
â”œâ”€â”€ mapdata\                         # Source data
â”‚   â”œâ”€â”€ mapbuilder.toml             # Configuration
â”‚   â”œâ”€â”€ sectors.txt                 # Sector definitions
â”‚   â”œâ”€â”€ class_g.geojson             # Custom airspace
â”‚   â”œâ”€â”€ aixm\                       # AIXM source files
â”‚   â””â”€â”€ templates\                  # Jinja2 templates
â”‚       â”œâ”€â”€ TopSkyMaps.txt.jinja
â”‚       â”œâ”€â”€ TopSkySettings.txt.jinja
â”‚       â””â”€â”€ GRP_CYHZ.txt.jinja
â”œâ”€â”€ output\                          # Generated files
â”‚   â”œâ”€â”€ TopSkyMaps.txt
â”‚   â”œâ”€â”€ TopSkySettings.txt
â”‚   â””â”€â”€ GRP_CYHZ.txt
â””â”€â”€ .cache\                          # Downloaded resources
```

---

## ğŸ“ Learning Path

### Phase 1: Understand the Tool (1-2 days)
1. âœ… Read README.md
2. âœ… Understand configuration format
3. âœ… Look at example templates
4. âœ… Test with simple data

### Phase 2: Create Test Data (3-5 days)
1. Extract subset of CZQM data
2. Convert to supported formats
3. Create simple templates
4. Generate test outputs

### Phase 3: Integration (1-2 weeks)
1. Parse your existing TopSkyMaps.txt
2. Identify sections to automate
3. Create proper templates
4. Compare output with manual version

### Phase 4: Production (2-4 weeks)
1. Full CZQM/CZQX implementation
2. AIRAC update workflow
3. CI/CD with GitHub Actions
4. Documentation for other staff

---

## ğŸ” Key Files to Study

### Understanding Data Parsing
```
mapbuilder/data/
â”œâ”€â”€ aixm2.py       # AIXM parsing - study this!
â”œâ”€â”€ kml.py         # KML parsing
â”œâ”€â”€ sectors.py     # Sector file parsing
â””â”€â”€ sidstar.py     # SID/STAR parsing
```

### Understanding Output Generation
```
mapbuilder/handlers/
â”œâ”€â”€ jinja.py       # Template rendering - important!
â””â”€â”€ plaintext.py   # Simple text output
```

### Understanding Geometry Operations
```
mapbuilder/utils/
â”œâ”€â”€ geo.py         # Geographic calculations
â”œâ”€â”€ ad.py          # Airport/runway rendering
â””â”€â”€ sidstar.py     # Procedure rendering
```

---

## âš ï¸ Important Notes

### Data Sources for Canada

1. **NAV CANADA AIXM:**
   - Not publicly available in AIXM format
   - May need to request from NAV CANADA
   - Or convert from other formats

2. **Alternative: Create GeoJSON**
   - Export from QGIS
   - Convert from sector files
   - Manual creation for special areas

3. **Use Your Existing Data:**
   - Your sector files (CZQQ.sct)
   - Your ESE files
   - Your existing TopSkyMaps.txt (as reference)

### Limitations

- Designed primarily for European data sources (DFS)
- No built-in NAV CANADA data access
- Learning curve for Jinja2 templates
- Need to understand AIXM structure

### Advantages

- âœ… Highly flexible
- âœ… Template-based (easy to modify output)
- âœ… Can combine multiple data sources
- âœ… Geometry processing built-in
- âœ… MIT license (free to use and modify)

---

## ğŸ¯ Recommended Next Steps

### Immediate (Today)
1. **Install dependencies:**
   ```bash
   cd D:\GitHub\mapbuilder
   pip install poetry --break-system-packages
   poetry install
   ```

2. **Test the tool:**
   ```bash
   poetry run mapbuilder --help
   ```

### Short Term (This Week)
1. **Study the German VATGER implementation:**
   - Look for their mapbuilder.toml
   - Study their templates
   - See how they structure data

2. **Create a simple test:**
   - Single sector from CZQM
   - Generate basic TopSky output
   - Verify it works in EuroScope

### Medium Term (This Month)
1. **Convert one feature to mapbuilder:**
   - Class G airspace (simplest)
   - Create GeoJSON source
   - Generate with template
   - Compare with manual version

2. **Document your findings:**
   - What works well
   - What's challenging
   - Time savings potential

### Long Term (This Quarter)
1. **Full CZQM integration:**
   - All major airspace features
   - Procedure definitions
   - Multiple airports (GRP)

2. **Automate AIRAC updates:**
   - GitHub Actions workflow
   - Automatic map generation
   - Version control

---

## ğŸ“š Resources

### Documentation
- **Jinja2:** https://jinja.palletsprojects.com/
- **Shapely:** https://shapely.readthedocs.io/ (geometry library)
- **AIXM:** http://www.aixm.aero/ (data format spec)

### Related Projects
- **VATGER Nav Data:** https://github.com/VATGER-Nav
- **EuroScope GRP:** Ground Radar Plugin documentation
- **TopSky:** TopSky plugin documentation

### Your Existing Tools
- **RF Arc Generator:** `D:\GitHub\CZQM-vACC\TopSky\Tools\rf-arc-generator\`
- Could be integrated with mapbuilder
- Or replace with mapbuilder functionality

---

## ğŸ’­ Final Thoughts

### Pros of Using Mapbuilder
âœ… Professional tool (used by German vACC)  
âœ… Handles multiple data formats  
âœ… Template-based (flexible output)  
âœ… Good geometry processing  
âœ… MIT license (free to use)  

### Cons / Challenges
âŒ Designed for European data (DFS)  
âŒ Learning curve for templates  
âŒ Need to convert NAV CANADA data  
âŒ May be overkill for simple tasks  

### My Recommendation

**Start small:**
1. Test with one simple feature (Class G airspace)
2. See if output quality is good
3. Evaluate time investment vs. benefit

**Consider hybrid approach:**
- Use mapbuilder for repetitive tasks (airspace boundaries)
- Keep your RF Arc Generator for procedures
- Manual work for complex special cases

**Long-term vision:**
- If it works well, expand usage
- Could save significant time on AIRAC updates
- Professional automated workflow

---

## ğŸ¤” Questions to Answer

Before committing to mapbuilder:

1. **Can you get NAV CANADA data in AIXM format?**
   - If no, how much work to convert?

2. **How much of TopSkyMaps.txt is automatable?**
   - Analyze current file structure
   - Identify repetitive patterns

3. **Time investment vs. time savings?**
   - Learning: 5-10 hours
   - Setup: 10-20 hours
   - Savings per AIRAC: 2-5 hours?

4. **Does it fit your workflow?**
   - Are you comfortable with templates?
   - Do you like automated processes?
   - Will other CZQM staff use it?

---

**Ready to experiment?** Start with `poetry install` and a simple test! ğŸš€
